<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>JJ Gateway</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, monospace; background: #0d1117; color: #c9d1d9; height: 100vh; display: flex; }
#sidebar { width: 260px; background: #161b22; border-right: 1px solid #30363d; display: flex; flex-direction: column; }
#sidebar-header { padding: 16px; border-bottom: 1px solid #30363d; display: flex; justify-content: space-between; align-items: center; }
#sidebar-header h2 { font-size: 14px; color: #58a6ff; }
#new-session { background: #238636; color: #fff; border: none; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; }
#new-session:hover { background: #2ea043; }
#session-list { flex: 1; overflow-y: auto; }
.session-item { padding: 10px 16px; border-bottom: 1px solid #21262d; cursor: pointer; }
.session-item:hover { background: #1c2128; }
.session-item.active { background: #1f6feb22; border-left: 2px solid #58a6ff; }
.session-key { font-size: 13px; font-weight: 600; color: #f0f6fc; cursor: pointer; }
.session-key:hover { text-decoration: underline; }
.session-meta { font-size: 11px; color: #8b949e; margin-top: 2px; }
.session-engine-badge { display: inline-block; font-size: 10px; padding: 1px 5px; border-radius: 3px; background: #30363d; color: #8b949e; margin-top: 3px; }
#main { flex: 1; display: flex; flex-direction: column; }
#chat-header { padding: 12px 16px; border-bottom: 1px solid #30363d; font-size: 13px; color: #8b949e; display: flex; align-items: center; gap: 12px; }
#engine-selector { background: #21262d; border: 1px solid #30363d; border-radius: 6px; padding: 4px 8px; color: #c9d1d9; font-size: 12px; font-family: inherit; outline: none; cursor: pointer; }
#engine-selector:focus { border-color: #58a6ff; }
#engine-selector option { background: #161b22; }
#messages { flex: 1; overflow-y: auto; padding: 16px; }
.message { margin-bottom: 12px; max-width: 80%; }
.message.user { margin-left: auto; }
.message.assistant { margin-right: auto; }
.message .bubble { padding: 8px 12px; border-radius: 8px; font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
.message.user .bubble { background: #1f6feb; color: #fff; }
.message.assistant .bubble { background: #21262d; color: #c9d1d9; }
.message.system .bubble { background: #1c1c1c; color: #8b949e; font-size: 12px; font-style: italic; }
.message.tool .bubble { background: #1a1e24; color: #7ee787; font-size: 12px; border: 1px solid #30363d; }
.msg-engine { font-size: 10px; color: #8b949e; margin-top: 2px; opacity: 0.7; }
#dashboard { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; }
#dashboard h2 { font-size: 20px; color: #f0f6fc; margin-bottom: 8px; }
#dashboard p { font-size: 13px; color: #8b949e; margin-bottom: 24px; }
#engine-table { border-collapse: collapse; width: 100%; max-width: 600px; }
#engine-table th, #engine-table td { text-align: left; padding: 10px 14px; border-bottom: 1px solid #21262d; font-size: 13px; }
#engine-table th { color: #8b949e; font-weight: 500; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
#engine-table td { color: #c9d1d9; }
.engine-status { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
.engine-status.available { background: #3fb950; }
.engine-status.unavailable { background: #484f58; }
.engine-active { color: #58a6ff; font-weight: 600; }
.engine-row { cursor: pointer; }
.engine-row:hover { background: #1c2128; }
.engine-row.active-engine { background: #1f6feb11; }
#input-area { padding: 12px 16px; border-top: 1px solid #30363d; display: flex; gap: 8px; }
#input { flex: 1; background: #0d1117; border: 1px solid #30363d; border-radius: 6px; padding: 8px 12px; color: #c9d1d9; font-size: 14px; font-family: inherit; outline: none; }
#input:focus { border-color: #58a6ff; }
#send { background: #238636; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; }
#send:hover { background: #2ea043; }
#send:disabled { opacity: 0.5; cursor: not-allowed; }
#status { padding: 4px 16px; font-size: 11px; color: #8b949e; border-top: 1px solid #21262d; }
.status-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 4px; }
.status-dot.connected { background: #3fb950; }
.status-dot.disconnected { background: #f85149; }
</style>
</head>
<body>

<div id="sidebar">
  <div id="sidebar-header">
    <h2>JJ Sessions</h2>
    <button id="new-session">+ New</button>
  </div>
  <div id="session-list"></div>
</div>

<div id="main">
  <div id="chat-header">
    <span id="header-text">Select or create a session</span>
    <select id="engine-selector" style="display:none"></select>
  </div>
  <div id="dashboard" style="display:none"></div>
  <div id="messages"></div>
  <div id="input-area">
    <input id="input" type="text" placeholder="Type a message..." disabled>
    <button id="send" disabled>Send</button>
  </div>
  <div id="status"><span class="status-dot disconnected"></span>Connecting...</div>
</div>

<script>
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);

let ws = null;
let currentSession = null;
let draftMode = false;
let pendingRequests = {};
let reqCounter = 0;
let engineList = []; // cached engine.list result
let currentSessionEngine = null; // engine for the active session

function genId() { return 'r' + (++reqCounter); }

function setStatus(connected, text) {
  const dot = $('#status .status-dot');
  dot.className = 'status-dot ' + (connected ? 'connected' : 'disconnected');
  $('#status').innerHTML = '';
  $('#status').appendChild(dot);
  $('#status').append(text);
}

function connect() {
  const port = location.port || '9123';
  const token = new URLSearchParams(location.search).get('token') || '';
  if (!token) {
    setStatus(false, 'No token. Add ?token=<bearer> to URL.');
    return;
  }

  ws = new WebSocket(`ws://127.0.0.1:${port}/ws`);

  ws.onopen = () => {
    ws.send(JSON.stringify({ token }));
  };

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);

    // Auth response
    if (msg.type === 'res' && msg.id === '0') {
      if (msg.ok) {
        setStatus(true, 'Connected');
        loadEngines();
        loadSessions();
        const resumeSession = new URLSearchParams(location.search).get('session');
        if (resumeSession) openSession(resumeSession);
        else showDashboard();
      } else {
        setStatus(false, 'Auth failed: ' + (msg.error?.message || '?'));
      }
      return;
    }

    // Response to a pending request
    if (msg.type === 'res' && pendingRequests[msg.id]) {
      const { resolve, reject } = pendingRequests[msg.id];
      delete pendingRequests[msg.id];
      if (msg.ok) resolve(msg.payload);
      else reject(new Error(msg.error?.message || 'request failed'));
      return;
    }

    // Event
    if (msg.type === 'event' || msg.event) {
      handleEvent(msg);
    }
  };

  ws.onclose = () => setStatus(false, 'Disconnected');
  ws.onerror = () => setStatus(false, 'Connection error');
}

function send(method, params) {
  return new Promise((resolve, reject) => {
    const id = genId();
    pendingRequests[id] = { resolve, reject };
    ws.send(JSON.stringify({ type: 'req', id, method, params }));
  });
}

// --- Engine management ---

async function loadEngines() {
  try {
    const result = await send('engine.list', {});
    engineList = result.engines || [];
    populateEngineSelector();
  } catch (_) {}
}

function populateEngineSelector() {
  const sel = $('#engine-selector');
  sel.innerHTML = '';
  engineList.forEach(e => {
    const opt = document.createElement('option');
    opt.value = e.engine;
    opt.textContent = e.engine + (e.available ? '' : ' (no key)');
    opt.disabled = !e.available;
    if (e.active && !currentSessionEngine) opt.selected = true;
    sel.appendChild(opt);
  });
  if (currentSessionEngine) sel.value = currentSessionEngine;
}

$('#engine-selector').onchange = async function() {
  const engine = this.value;
  if (!currentSession) return;
  try {
    const result = await send('engine.set', { session_key: currentSession, engine });
    currentSessionEngine = result.engine;
  } catch (e) {
    addMessage('system', 'Engine switch failed: ' + e.message);
    // revert selector
    if (currentSessionEngine) this.value = currentSessionEngine;
  }
};

function showDashboard() {
  $('#messages').style.display = 'none';
  const dash = $('#dashboard');
  dash.style.display = 'flex';
  dash.innerHTML = '';

  const h2 = document.createElement('h2');
  h2.textContent = 'Engines';
  dash.appendChild(h2);

  const p = document.createElement('p');
  p.textContent = 'Available LLM engines and their configuration';
  dash.appendChild(p);

  const table = document.createElement('table');
  table.id = 'engine-table';
  const thead = document.createElement('thead');
  thead.innerHTML = '<tr><th>Engine</th><th>Status</th><th>Model</th><th>Base URL</th></tr>';
  table.appendChild(thead);

  const tbody = document.createElement('tbody');
  engineList.forEach(e => {
    const tr = document.createElement('tr');
    tr.className = 'engine-row' + (e.active ? ' active-engine' : '');
    const statusClass = e.available ? 'available' : 'unavailable';
    const statusText = e.available ? 'Available' : 'No API key';
    const nameClass = e.active ? ' engine-active' : '';
    // Truncate base URL for display
    let displayUrl = e.base_url || '';
    try { displayUrl = new URL(displayUrl).hostname; } catch(_) {}
    tr.innerHTML = `<td class="${nameClass}">${esc(e.engine)}${e.active ? ' *' : ''}</td><td><span class="engine-status ${statusClass}"></span>${statusText}</td><td>${esc(e.model)}</td><td>${esc(displayUrl)}</td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  dash.appendChild(table);

  $('#header-text').textContent = 'Engine Dashboard';
  $('#engine-selector').style.display = 'none';
  $('#input').disabled = true;
  $('#send').disabled = true;
}

function hideDashboard() {
  $('#dashboard').style.display = 'none';
  $('#messages').style.display = '';
}

// --- Events ---

function handleEvent(msg) {
  const event = msg.event;
  const payload = msg.payload || {};
  const sessionId = msg.session_id;

  // Title events should update sidebar for any session
  if (event === 'title_generated') {
    updateSessionTitle(sessionId, payload.title);
    return;
  }

  if (sessionId !== currentSession) return;

  switch (event) {
    case 'user_message':
      addMessage('user', payload.content);
      break;
    case 'delta':
      appendDelta(payload.text || '');
      break;
    case 'final':
      finalizeDelta(payload.content || '');
      break;
    case 'tool_call_start': {
      const name = payload.tool_name || 'tool';
      const args = payload.arguments || {};
      const detail = args.query || args.doc_path || args.prompt || args.source || '';
      const short = detail.length > 80 ? detail.slice(0, 80) + '...' : detail;
      addMessage('tool', short ? `[${name}: ${short}]` : `[${name}]`);
      break;
    }
    case 'tool_call_result': {
      const toolName = payload.tool_name || '';
      const result = payload.result || {};
      const data = result.data || {};
      if ((toolName === 'generate_image' || toolName === 'draw') && result.status === 'ok') {
        const imgPath = data.path || data.drawn || '';
        if (imgPath) {
          const src = imgPath.startsWith('media/') ? '/' + imgPath : imgPath;
          addImage(src);
        }
      }
      break;
    }
    case 'tool_activity':
      addMessage('tool', `[${payload.tool_name || 'tool'}]`);
      break;
    case 'error':
      addMessage('system', 'Error: ' + (payload.message || '?'));
      break;
  }
}

function updateSessionTitle(sessionKey, title) {
  const items = $$('.session-item');
  items.forEach(item => {
    if (item.dataset.sessionKey === sessionKey) {
      const keyEl = item.querySelector('.session-key');
      if (keyEl) keyEl.textContent = title;
    }
  });
}

function addMessage(role, text, engineInfo) {
  const div = document.createElement('div');
  div.className = 'message ' + role;
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.textContent = text;
  div.appendChild(bubble);
  if (engineInfo) {
    const badge = document.createElement('div');
    badge.className = 'msg-engine';
    badge.textContent = engineInfo;
    div.appendChild(badge);
  }
  $('#messages').appendChild(div);
  $('#messages').scrollTop = $('#messages').scrollHeight;
}

function addImage(src) {
  const div = document.createElement('div');
  div.className = 'message assistant';
  const img = document.createElement('img');
  img.src = src;
  img.style.maxWidth = '100%';
  img.style.borderRadius = '8px';
  img.style.maxHeight = '400px';
  img.onerror = () => { img.alt = 'Image failed to load: ' + src; };
  div.appendChild(img);
  $('#messages').appendChild(div);
  $('#messages').scrollTop = $('#messages').scrollHeight;
}

let deltaDiv = null;
function appendDelta(text) {
  if (!deltaDiv) {
    deltaDiv = document.createElement('div');
    deltaDiv.className = 'message assistant';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    deltaDiv.appendChild(bubble);
    $('#messages').appendChild(deltaDiv);
  }
  deltaDiv.querySelector('.bubble').textContent += text;
  $('#messages').scrollTop = $('#messages').scrollHeight;
}

function finalizeDelta(text) {
  if (deltaDiv) {
    deltaDiv.querySelector('.bubble').textContent = text;
    deltaDiv = null;
  } else {
    addMessage('assistant', text);
  }
}

// --- Sessions ---

async function loadSessions() {
  const result = await send('session.list', {});
  const list = result.sessions || [];
  renderSessionList(list);
}

function renderSessionList(sessions) {
  const el = $('#session-list');
  el.innerHTML = '';
  sessions.sort((a, b) => (b.updated_at || b.created_at || '').localeCompare(a.updated_at || a.created_at || ''));
  sessions.forEach(s => {
    const div = document.createElement('div');
    div.className = 'session-item' + (s.session_key === currentSession ? ' active' : '');
    const displayName = s.title || s.first_user_line || s.session_key;
    div.dataset.sessionKey = s.session_key;
    let meta = esc(s.thread_id);
    if (s.engine) meta += ` | ${esc(s.engine)}`;
    div.innerHTML = `<div class="session-key">${esc(displayName)}</div><div class="session-meta">${meta}</div>`;
    div.onclick = () => openSession(s.session_key);
    el.appendChild(div);
  });
}

async function openSession(key) {
  currentSession = key;
  hideDashboard();
  // Persist session in URL for refresh
  const url = new URL(location.href);
  url.searchParams.set('session', key);
  history.replaceState(null, '', url.toString());

  const result = await send('session.open', { session_key: key });

  // Set engine selector to this session's engine
  currentSessionEngine = result.engine || null;
  if (currentSessionEngine) {
    $('#engine-selector').value = currentSessionEngine;
  }

  $('#header-text').textContent = 'Session: ' + key;
  $('#engine-selector').style.display = '';
  $('#messages').innerHTML = '';
  $('#input').disabled = false;
  $('#send').disabled = false;
  deltaDiv = null;

  // Load history
  const hist = await send('session.history', { session_key: key, limit: 100 });
  (hist.events || []).forEach(line => {
    try {
      const ev = JSON.parse(line);
      const content = typeof ev.content === 'string' ? ev.content : (ev.content ? JSON.stringify(ev.content) : '');
      if (!content) return;
      // Build engine attribution string
      const engineInfo = (ev.engine || ev.model) ? [ev.engine, ev.model].filter(Boolean).join(' / ') : null;
      switch (ev.type) {
        case 'user_message': addMessage('user', content); break;
        case 'assistant_message': addMessage('assistant', content, engineInfo); break;
        case 'tool_call': addMessage('tool', `[${ev.tool_name || 'tool'}] ${JSON.stringify(ev.tool_args || {})}`); break;
        case 'system_note': addMessage('system', content); break;
      }
    } catch (_) {}
  });

  // Refresh sidebar
  loadSessions();
}

async function sendMessage() {
  const input = $('#input');
  const text = input.value.trim();
  if (!text) return;
  if (!currentSession && !draftMode) return;
  input.value = '';
  try {
    if (draftMode) {
      const key = 'session-' + Date.now();
      await send('session.open', { session_key: key });
      currentSession = key;
      draftMode = false;
      hideDashboard();
      const url = new URL(location.href);
      url.searchParams.set('session', key);
      history.replaceState(null, '', url.toString());
      $('#header-text').textContent = 'Session: ' + key;
      $('#engine-selector').style.display = '';
    }
    await send('session.send', { session_key: currentSession, content: text });
    loadSessions();
  } catch (e) {
    addMessage('system', 'Send failed: ' + e.message);
  }
}

$('#send').onclick = sendMessage;
$('#input').onkeydown = (e) => { if (e.key === 'Enter') sendMessage(); };
$('#new-session').onclick = async () => {
  currentSession = null;
  currentSessionEngine = null;
  draftMode = true;
  deltaDiv = null;
  $('#header-text').textContent = 'New conversation';
  $('#messages').innerHTML = '';
  $('#input').disabled = false;
  $('#send').disabled = false;
  $('#engine-selector').style.display = '';
  hideDashboard();
  // Remove session from URL
  const url = new URL(location.href);
  url.searchParams.delete('session');
  history.replaceState(null, '', url.toString());
  // Deselect sidebar items
  $$('.session-item').forEach(i => i.classList.remove('active'));
  // Fetch and display system prompt
  try {
    const result = await send('system.prompt', {});
    if (result.prompt) addMessage('system', result.prompt);
  } catch (_) {}
  $('#input').focus();
};

function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

connect();
</script>
</body>
</html>
