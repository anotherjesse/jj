{"ledger_id":"led_01KGAHB6N028ADRCCMH2K526PV","ts":"2026-01-31T17:24:23.328598Z","author":"ingest-agent","reason":"Create a concise source summary of the JJ Gateway v0.1 plan/spec for future reference by implementation agents.","op":"upsert_knowledge","doc_path":"summaries/sources/jj-gateway-v-0.md","doc_id":"mem_01KGAHB6MZ6CGJNQKQSTC1JQTY","new_hash":"4553feea99f27fb1cbc3421eea3054ba2eccdb735fee753a295edfa6b665a8e2","patch":{"doc_path":"summaries/sources/jj-gateway-v-0.md","title":"JJ Gateway v0.1 — Formal Plan / Spec (CLI + Telegram)","type":"source_summary","status":"active","tags_add":["jj","gateway","spec","cli","telegram","event-sourcing","websocket"],"confidence":0.9,"body_append":"## Summary\n\nJJ Gateway v0.1 specifies a first shippable “Gateway + Agent Loop” system with two message channels—local CLI (`jj chat`) and Telegram bot—both routed through a single local daemon (`jj gateway`). The Gateway is the control plane: it manages sessions, persists transcripts, coordinates a per-session serialized agent run loop (LLM streaming), and routes outbound responses back to the originating channel.\n\nCore design principles: session key is the unit of consistency; all state is derived from an append-only event log (JSONL transcript per session); the daemon is crash-only and restart-safe via replay/rehydration from `sessions.json` + transcripts; idempotency is required to make retries safe and prevent duplicate side effects (notably for Telegram update delivery and client reconnect retries).\n\nArchitecture components: Gateway Core (session manager, run coordinator, model provider interface, internal event bus/router), CLI Adapter (WebSocket client with streaming display and reconnect/resubscribe), and Telegram Adapter (long polling via `getUpdates`, mapping `tg:<chat_id>` to session keys, dedupe via durable offset/update tracking, and outbound `sendMessage`). Concurrency model: one active run per session key; cross-session concurrency allowed with a configurable global cap.\n\nPersistence layout defaults to `~/.jj/gateway/` with `sessions.json` as a small index (metadata + channel bindings) and `transcripts/<session_id>.jsonl` as source-of-truth logs (header + typed entries: `message`, `assistant_delta` optional, `assistant_final`, `error`). Idempotency can be implemented with a dedicated `dedupe/` store or via scanning recent transcript lines.\n\nGateway API for CLI: JSON frames over loopback WebSocket (`gateway.hello`, `session.open`, `session.send`, `session.subscribe`, `session.history`, dev-only `gateway.shutdown`), and events (`run.started`, `assistant.delta`, `assistant.final`, `run.completed`, `error`). Config lives at `~/.jj/gateway/config.toml` with sections for gateway, model provider, and Telegram; secrets must be env-var only. Deliverables include Rust workspace layout, tests (persistence, idempotency, WS happy path, Telegram dedupe with mocks), and docs (quickstart/protocol/storage).","sources_add":[{"thread_id":"","event_ids":["src_01KGAH9QWXDTVYBKPNG42FDGDE"]}]}}
{"ledger_id":"led_01KGAHB6N1VNP9KP1SAR1S2ZAE","ts":"2026-01-31T17:24:23.329426Z","author":"ingest-agent","reason":"Record the JJ Gateway v0.1 effort as a concrete project with deliverables, components, milestones, and acceptance criteria.","op":"upsert_knowledge","doc_path":"knowledge/projects/jj-gateway.md","doc_id":"mem_01KGAHB6N1NY1HKH25H9JYNZSM","new_hash":"92cd9c3ef34c8b0c7b0e9c6b3d3d91bc4efed04675b34ba297901f8ca1170e46","patch":{"doc_path":"knowledge/projects/jj-gateway.md","title":"JJ Gateway (v0.1)","type":"project","status":"active","tags_add":["jj","gateway","daemon","cli","telegram","rust","websocket","event-sourcing"],"confidence":0.9,"body_append":"## Overview\n\nJJ Gateway v0.1 is a local “control plane” daemon (`jj gateway`) plus channel adapters that together provide durable, replayable chat sessions and an agent execution loop. Channels in v0.1: local CLI REPL (`jj chat`) and Telegram bot (long polling). All inbound/outbound messages flow through the Gateway.\n\n## Goals (v0.1)\n\n- One long-running daemon that owns:\n  - session storage/index and transcripts\n  - message intake from CLI + Telegram\n  - per-session serialized agent loop with LLM streaming\n  - outbound routing back to channels\n- Durable sessions: append-only per-session transcripts (`.jsonl`) + `sessions.json` index.\n- Restart-safe/crash-only operation; idempotency for side-effecting operations.\n\n## Non-goals (deferred)\n\n- Multi-node device capabilities (camera/screen/etc)\n- Tool/plugin marketplace, deep tool system\n- Subagents/lanes beyond minimal per-session serialization\n- Cron scheduler\n- Full web UI\n\n## Key design principles\n\n- Session key is unit of consistency; only one active run per session key.\n- Event log is source of truth; state derived from transcripts.\n- Crash-only + replayable via rehydration from `sessions.json` + transcript JSONL.\n- Idempotency for protocol methods and inbound message dedupe.\n\n## Components\n\n- **Gateway Core**: session manager, run coordinator, model provider interface, internal event bus, channel router.\n- **CLI Adapter**: `jj chat` WebSocket client with streaming output, reconnect/resubscribe.\n- **Telegram Adapter**: long polling `getUpdates`, map `tg:<chat_id>` to sessions, dedupe, outbound `sendMessage`.\n\n## Storage\n\nDefault root: `~/.jj/gateway/`\n- `sessions.json` (small index/metadata)\n- `transcripts/<session_id>.jsonl` (append-only header + typed entries)\n- optional: `dedupe/`, `logs/` (stream capture)\n\n## Protocol/API (loopback WebSocket)\n\nClient frames:\n- req: `{type:req,id,method,params,idempotency_key}`\n- res: `{type:res,id,ok,payload}`\n- event: `{type:event,event,payload,seq}`\n\nMethods (v0.1): `gateway.hello`, `session.open`, `session.send`, `session.subscribe`, `session.history`, dev-only `gateway.shutdown`.\n\nEvents: `run.started`, `assistant.delta`, `assistant.final`, `run.completed`, `error`.\n\n## Configuration\n\nConfig file: `~/.jj/gateway/config.toml` (or `--config`). Sections:\n- `[gateway]` port, data_dir, log_level, max_concurrency\n- `[model]` provider, model, api_key_env\n- `[telegram]` enabled, bot_token_env, allow_chat_ids\n\nSecrets via env vars only; never written to transcripts/logs.\n\n## Milestones\n\n- M0 scaffold: daemon starts, WS handshake, CLI connects\n- M1 sessions + persistence\n- M2 agent loop streaming (CLI)\n- M3 Telegram adapter + restart-safe dedupe\n- M4 hardening (idempotency store, backoff/retry, shutdown)\n\n## Definition of Done highlights\n\n- Rust workspace: `crates/jj-gateway`, `crates/jj-cli`, `crates/jj-proto`, plus docs/examples.\n- `cargo build --workspace` + `cargo test --workspace` pass.\n- Restart-safe sessions/history; idempotent `session.send` does not duplicate transcript entries.\n- Telegram allowlist default-deny; restart does not replay old updates.\n","sources_add":[{"thread_id":"","event_ids":["src_01KGAH9QWXDTVYBKPNG42FDGDE"]}]}}
{"ledger_id":"led_01KGAHB6N2EZSK07NEJCVAGZVR","ts":"2026-01-31T17:24:23.330121Z","author":"ingest-agent","reason":"Capture system-level facts about JJ Gateway v0.1 architecture, storage, protocol, and operational invariants that other agents can rely on.","op":"upsert_knowledge","doc_path":"knowledge/system/jj-gateway-architecture.md","doc_id":"mem_01KGAHB6N1JNPM0C723JVFMMXQ","new_hash":"fc37ba140aa419e2affc24b408a0840b27ed21eb119ae1ca0849900ce3b0abb8","patch":{"doc_path":"knowledge/system/jj-gateway-architecture.md","title":"JJ Gateway v0.1 system architecture & invariants","type":"system","status":"active","tags_add":["jj","gateway","architecture","event-sourcing","idempotency","sessions","websocket","telegram"],"confidence":0.9,"body_append":"## Core invariants\n\n- **Gateway is the control plane**: all channel messages (CLI, Telegram) are normalized into internal events and flow through the daemon.\n- **Session key is the unit of consistency**: one serialized agent run per `session_key`.\n- **Event log is source of truth**: state is derived from append-only per-session transcript JSONL.\n- **Crash-only + replayable**: restart rehydrates from `sessions.json` + transcript logs.\n- **Idempotency everywhere**: retries must be safe across restarts/network failures.\n\n## Concurrency model (v0.1)\n\n- Per-session lock ensures only one active run per `session_key`.\n- Cross-session concurrency allowed; capped by configurable global semaphore (`max_concurrency`).\n\n## Channels / adapters\n\n- **CLI**: `jj chat` WebSocket client connects to loopback server, subscribes to session events, displays streaming deltas.\n- **Telegram**: long polling `getUpdates`, maps chats to `session_key = tg:<chat_id>`, ignores non-text messages in v0.1, sends final responses with `sendMessage`.\n\n## Storage layout\n\nDefault root: `~/.jj/gateway/`\n- `sessions.json` (index: `session_key -> {session_id, metadata, channel bindings, model flags}`)\n- `transcripts/<session_id>.jsonl` (append-only)\n- optional: `dedupe/` (idempotency records), `logs/` (raw stream capture)\n\n### Transcript entry types (v0.1 minimal)\n\n- `header` (first line)\n- `message` (user)\n- `assistant_delta` (optional/debug)\n- `assistant_final`\n- `error`\n\n## Gateway WebSocket protocol\n\n- Request frame: `{ \"type\":\"req\", \"id\":\"uuid\", \"method\":\"...\", \"params\":{...}, \"idempotency_key\":\"...\" }`\n- Response frame: `{ \"type\":\"res\", \"id\":\"uuid\", \"ok\":true, \"payload\":{...} }`\n- Event frame: `{ \"type\":\"event\", \"event\":\"assistant.delta\", \"payload\":{...}, \"seq\":123 }`\n\nRequired methods: `gateway.hello`, `session.open`, `session.send`, `session.subscribe`, `session.history`, dev-only `gateway.shutdown`.\n\nEvents: `assistant.delta`, `assistant.final`, `run.started`, `run.completed`, `error`.\n\n## Configuration\n\n`~/.jj/gateway/config.toml` sections:\n- `[gateway]` port, data_dir, log_level, max_concurrency\n- `[model]` provider, model, api_key_env\n- `[telegram]` enabled, bot_token_env, allow_chat_ids\n\nSecrets are loaded from environment variables and must not be persisted in transcripts/logs.\n","sources_add":[{"thread_id":"","event_ids":["src_01KGAH9QWXDTVYBKPNG42FDGDE"]}]}}
{"ledger_id":"led_01KGAHB6N2V9Z8NHWTAGBXSS7J","ts":"2026-01-31T17:24:23.330820Z","author":"ingest-agent","reason":"Extract explicit preference-like requirements around security, secrets handling, and minimal v0.1 scope from the spec.","op":"upsert_knowledge","doc_path":"knowledge/prefs/jj-gateway-v0-constraints.md","doc_id":"mem_01KGAHB6N20MV56DR4WKR1KMDS","new_hash":"7876a3023b5f1c9dfdcc09d6480ec5e3f0503ca8efb6792763f9fde95f2e3386","patch":{"doc_path":"knowledge/prefs/jj-gateway-v0-constraints.md","title":"JJ Gateway v0.1 constraints & preferences","type":"preference","status":"active","tags_add":["jj","gateway","preferences","security","scope","operations"],"confidence":0.85,"body_append":"## Scope preferences\n\n- v0.1 focuses on a single-node local daemon + two channels (CLI + Telegram) with durable sessions.\n- Defer: web UI, cron, subagents/lanes, tool marketplace, multi-device capabilities.\n\n## Operational preferences\n\n- **Crash-only daemon**: prefer restart over in-place upgrades; continuity via transcripts + session index.\n- Provide graceful shutdown (`SIGINT`/`SIGTERM` + dev-only `gateway.shutdown`).\n\n## Security/safety preferences (v0.1 minimal)\n\n- Gateway should listen on **loopback only** (no remote access).\n- Telegram adapter should be **default deny** via allowlist of chat IDs (or user IDs later).\n- No remote admin endpoints.\n\n## Secrets handling\n\n- Never store model API keys or Telegram bot tokens in transcripts.\n- Load secrets only via environment variables specified in config (e.g., `OPENAI_API_KEY`, `TELEGRAM_BOT_TOKEN`).\n","sources_add":[{"thread_id":"","event_ids":["src_01KGAH9QWXDTVYBKPNG42FDGDE"]}]}}
