{"ledger_id":"led_01KGAH88MYYDB3PKQ8S78Q00EF","ts":"2026-01-31T17:22:47.070923Z","author":"ingest-agent","reason":"Create a concise source summary for the JJ Gateway v0.1 plan/spec for future reference by implementation agents.","op":"upsert_knowledge","doc_path":"summaries/sources/jj-gateway-v-0.md","doc_id":"mem_01KGAH88MYGZT011MPWNRFZ7MQ","new_hash":"3f0bd84524a104ac86aeae4ced9278d5b334abb0f78c3b567e2033f99314fd4d","patch":{"doc_path":"summaries/sources/jj-gateway-v-0.md","title":"JJ Gateway v0.1 — Formal Plan / Spec (CLI + Telegram)","type":"source_summary","status":"active","tags_add":["jj","gateway","spec","cli","telegram","event-sourcing","rust"],"confidence":0.88,"body_append":"## Summary\nJJ Gateway v0.1 defines a crash-only, restart-safe local “control plane” daemon (`jj gateway`) that centralizes message intake from multiple channels (initially a local CLI REPL `jj chat` and a Telegram bot) and runs a serialized per-session agent loop with streaming responses. The system treats a **session** (identified by a stable `session_key` like `main` or `tg:<chat_id>`) as the unit of consistency: only one active run per session at a time, while multiple sessions can run concurrently with a global concurrency cap.\n\nThe core durability model is **event sourcing** via append-only per-session **transcripts** stored as JSONL files under `~/.jj/gateway/transcripts/<session_id>.jsonl`, with a small `sessions.json` index mapping `session_key → session_id` plus metadata (bindings, model config, flags). On restart, the daemon rehydrates state from `sessions.json` + transcripts. Transcript entries include a header plus minimal event types: user `message`, optional `assistant_delta` (debug), `assistant_final`, and `error`.\n\nCLI and other clients talk to the Gateway over a loopback WebSocket protocol. Frames are JSON request/response/event objects. Required methods: `gateway.hello`, `session.open`, `session.send`, `session.subscribe`, `session.history`, and dev-only `gateway.shutdown`. Events include `run.started`, `assistant.delta`, `assistant.final`, `run.completed`, and `error`. **Idempotency keys** are required for side-effecting operations and for inbound message dedupe (particularly Telegram long-poll `getUpdates` replay). A dedupe store may live in `dedupe/` or be derived from transcript scanning.\n\nTelegram integration is via long polling, mapping chats to `session_key = tg:<chat_id>`, ignoring non-text messages in v0.1, and using an allowlist by default. Outbound delivery uses `sendMessage` with final assistant text (streaming to Telegram is optional/deferred). Configuration lives in `~/.jj/gateway/config.toml` (or `--config`), with secrets loaded only from environment variables. The spec includes milestones (M0–M4), minimum test plan (restart safety, idempotency, Telegram dedupe, concurrency), and deliverables including a Rust workspace layout (`crates/jj-gateway`, `crates/jj-cli`, `crates/jj-proto`).\n","sources_add":[{"thread_id":"","event_ids":["src_01KGAH6T2E37N2SRV9HAVZX7GV"]}]}}
{"ledger_id":"led_01KGAH88MZVZC0BZ58NQRKGKZB","ts":"2026-01-31T17:22:47.071648Z","author":"ingest-agent","reason":"Record the JJ Gateway project as described in the spec (scope, components, deliverables).","op":"upsert_knowledge","doc_path":"knowledge/projects/jj-gateway.md","doc_id":"mem_01KGAH88MZ5M8J4BC5BRWAAN4B","new_hash":"59912a26759ab549a4f172e1666d7c55d78fe3c4739f9cee5025d4dd6f76a31f","patch":{"doc_path":"knowledge/projects/jj-gateway.md","title":"JJ Gateway","type":"project","status":"active","tags_add":["jj","gateway","daemon","cli","telegram","websocket","event-sourcing"],"confidence":0.86,"body_append":"## Overview\nJJ Gateway (v0.1) is a local, crash-only daemon (`jj gateway`) acting as a control plane for conversational sessions across channels (initially `jj chat` CLI and Telegram). It owns session storage, transcripts, message routing, and a minimal agent execution loop with streaming.\n\n## Goals (v0.1)\n- Single long-running gateway daemon with restart-safe state.\n- CLI REPL (`jj chat`) and Telegram bot adapters route through the same gateway.\n- Durable, replayable sessions using event-sourced transcripts.\n- Idempotent operations and inbound message dedupe.\n\n## Architecture\n- **Gateway Core**: session manager (index + transcripts), run coordinator (per-session serialization), model provider interface, internal event bus, router.\n- **Channel adapters**:\n  - CLI adapter over loopback WebSocket.\n  - Telegram adapter via long polling (`getUpdates`) and outbound `sendMessage`.\n\n## Persistence Model\n- Data root (default): `~/.jj/gateway/`\n- `sessions.json`: small index mapping `session_key → session_id` + metadata.\n- `transcripts/<session_id>.jsonl`: append-only event log per session (header + message/final/error; optional delta).\n- Optional `dedupe/` for idempotency records and `logs/` for raw stream capture.\n\n## Protocol Surface (v0.1)\nWebSocket JSON frames with request/response/event shapes.\n- Methods: `gateway.hello`, `session.open`, `session.send`, `session.subscribe`, `session.history`, dev-only `gateway.shutdown`.\n- Events: `run.started`, `assistant.delta`, `assistant.final`, `run.completed`, `error`.\n\n## Deliverables / Repo Layout\nRust workspace:\n- `crates/jj-gateway/` (daemon)\n- `crates/jj-cli/` (CLI)\n- `crates/jj-proto/` (shared protocol types/schemas)\n- `docs/`, `examples/`\n\n## Milestones\nM0 scaffold → M1 sessions/persistence → M2 agent loop streaming → M3 Telegram adapter → M4 hardening (idempotency, retries, shutdown).\n","sources_add":[{"thread_id":"","event_ids":["src_01KGAH6T2E37N2SRV9HAVZX7GV"]}]}}
{"ledger_id":"led_01KGAH88N02TXEJTR9S1M72C4G","ts":"2026-01-31T17:22:47.072345Z","author":"ingest-agent","reason":"Capture system facts about JJ Gateway persistence, protocol, configuration, and operational constraints for later implementation and troubleshooting.","op":"upsert_knowledge","doc_path":"knowledge/system/jj-gateway-v0-architecture.md","doc_id":"mem_01KGAH88N0V8BY1ECT16WY6RAT","new_hash":"0cc908bcb5675c28b70e28531ee0c5924b78d1c6f3901a388dd2e94759a18c53","patch":{"doc_path":"knowledge/system/jj-gateway-v0-architecture.md","title":"JJ Gateway v0.1 — Architecture & System Facts","type":"system","status":"active","tags_add":["jj","gateway","websocket","transcripts","sessions","idempotency","telegram"],"confidence":0.87,"body_append":"## Design principles\n- Gateway is the control plane: all channel messages flow through it.\n- Session is the unit of consistency: one serialized run per `session_key`.\n- Event log is source of truth: state derived from append-only transcript JSONL.\n- Crash-only + replayable: restart rehydrates from `sessions.json` + transcripts.\n- Idempotency everywhere: safe retries after restarts/network failures.\n\n## Terminology\n- **Session key**: stable human-meaningful id (`main`, `tg:<chat_id>`).\n- **Session ID**: internal UUID used for transcript filenames.\n- **Run**: one agent turn (user msg → streaming → final assistant).\n\n## Concurrency model (v0.1)\n- Serialize runs per session key (per-session lock).\n- Allow cross-session concurrency with a configurable global semaphore/cap.\n\n## Storage layout (default)\nRoot: `~/.jj/gateway/`\n- `sessions.json`\n- `transcripts/<session_id>.jsonl`\n- optional: `dedupe/` (idempotency records), `logs/` (including `logs/stream/*.jsonl`)\n\n## sessions.json (concept)\n- Small index mapping `session_key → {session_id, timestamps, channel_bindings, model, flags}`.\n- Avoid storing conversation content.\n\n## Transcript JSONL\n- One file per session; append-only.\n- First line is a header entry.\n- Minimal entry types: `header`, `message` (user), optional `assistant_delta` (debug), `assistant_final`, `error`.\n\n## Gateway API transport and framing\n- Loopback WebSocket (preferred) using JSON frames.\n- Request: `{type:req, id, method, params, idempotency_key}`\n- Response: `{type:res, id, ok, payload}`\n- Event: `{type:event, event, payload, seq}`\n\n## Required methods/events (v0.1)\nMethods: `gateway.hello`, `session.open`, `session.send`, `session.subscribe`, `session.history`, dev-only `gateway.shutdown`.\nEvents: `assistant.delta`, `assistant.final`, `run.started`, `run.completed`, `error`.\n\n## Configuration and secrets\n- Config file: `~/.jj/gateway/config.toml` (override via `--config`).\n- Sections: `[gateway] port/data_dir/log_level/max_concurrency`, `[model] provider/model/api_key_env`, `[telegram] enabled/bot_token_env/allow_chat_ids`.\n- Secrets loaded via env vars only; must not be written to transcripts/logs.\n\n## Telegram adapter facts (v0.1)\n- Long polling via `getUpdates` with durable `offset` state (could be `sessions.json` or separate `telegram_state.json`).\n- Session mapping: `session_key = tg:<chat_id>`.\n- Dedupe by `update_id` and/or `(chat_id, message_id)`; never process same update twice even after restart.\n- Outbound: `sendMessage(chat_id, text)`; streaming optional/deferred.\n- Security: allowlist chat IDs by default (default deny unless configured).\n","sources_add":[{"thread_id":"","event_ids":["src_01KGAH6T2E37N2SRV9HAVZX7GV"]}]}}
{"ledger_id":"led_01KGAH88N0DZ45BCX1XHWCQ16E","ts":"2026-01-31T17:22:47.072911Z","author":"ingest-agent","reason":"Capture stated implementation preferences/design principles (event sourcing, crash-only, idempotency, loopback-only, deterministic prompt assembly).","op":"upsert_knowledge","doc_path":"knowledge/prefs/jj-gateway-design-principles.md","doc_id":"mem_01KGAH88N0NDV9DRQR7PZVGEFN","new_hash":"41bd76bec1e3b88b77939868daa47c71e8501b56c8f86a3771baf44d4af9b47c","patch":{"doc_path":"knowledge/prefs/jj-gateway-design-principles.md","title":"JJ Gateway — Design/Implementation Preferences (v0.1)","type":"preference","status":"active","tags_add":["jj","gateway","preferences","event-sourcing","crash-only","idempotency"],"confidence":0.84,"body_append":"## Preferences / guiding rules\n- Centralize control in the Gateway: all channel traffic routes through the daemon.\n- Prefer **event sourcing**: append-only transcript JSONL is the source of truth.\n- Prefer **crash-only** operational model: restart is the normal recovery path.\n- Make operations **restart-safe** using idempotency keys and durable dedupe.\n- Keep prompt assembly deterministic; include session metadata in non-user-visible context.\n- Keep `sessions.json` small (index + metadata only); do not store full conversation content there.\n- Default to loopback-only listening (local-only gateway) for safety.\n- For Telegram v0.1 choose long polling first; streaming to Telegram is optional/deferred.\n- Do not persist secrets (API keys/bot tokens) into transcripts or logs; load via env vars.\n","sources_add":[{"thread_id":"","event_ids":["src_01KGAH6T2E37N2SRV9HAVZX7GV"]}]}}
